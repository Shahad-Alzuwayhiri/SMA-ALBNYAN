# نظام تصدير العقود إلى PDF

## نظرة عامة
تم تطوير نظام تصدير العقود إلى PDF باستخدام HTML وCSS بدلاً من مكتبات PDF المعقدة مثل TCPDF، مما يوفر مرونة أكبر وسهولة في التخصيص.

## الميزات الجديدة

### 1. ترقيم العقود التلقائي ✅
- تم إنشاء نظام ترقيم تلقائي يعمل مع SQLite
- التنسيق: B001-1447, B002-1447, B003-1447
- يستخدم التاريخ الهجري الحالي (1447 هـ)
- رقم تسلسلي متزايد تلقائياً

### 2. تصدير PDF محسّن ✅
- خدمة PDF مبسطة باستخدام HTML/CSS
- تصميم احترافي مع دعم كامل للعربية
- إمكانية الطباعة المباشرة من المتصفح
- تنسيق متجاوب يعمل على جميع الأجهزة

### 3. واجهة مستخدم محسّنة ✅
- صفحة قائمة العقود مع إحصائيات
- أزرار تصدير PDF مباشرة
- تصميم عصري ومتجاوب
- أيقونات وألوان متسقة

## الملفات الجديدة

### 1. خدمة PDF المبسطة
```
php_app/services/SimplePdfService.php
```
- إنشاء HTML قابل للطباعة كـ PDF
- قالب احترافي مع CSS متقدم
- دعم كامل للنصوص العربية
- تخطيط متجاوب للطباعة

### 2. صفحة قائمة العقود
```
php_app/contracts_list.php
```
- عرض جميع العقود مع الإحصائيات
- أزرار تصدير PDF لكل عقد
- إمكانيات البحث والتصفية
- واجهة مستخدم حديثة

### 3. صفحة تصدير PDF
```
php_app/export_pdf.php
```
- تصدير مباشر للعقود
- معالجة الأخطاء
- أمان وتحقق من الصلاحيات

### 4. ملف الاختبار
```
php_app/test_pdf.php
```
- اختبار سريع لنظام PDF
- عرض العقد الأول كمثال
- مفيد للتطوير والاختبار

## المحسنات في الملفات الحالية

### 1. DetailedContractController.php
- تحديث دالة exportPdf()
- استخدام SimplePdfService
- تحسين معالجة البيانات

### 2. ملفات المساعدة
```
php_app/helpers/contract_helpers.php
```
- دوال توليد أرقام العقود
- تحويل التاريخ الهجري
- دعم SQLite

## كيفية الاستخدام

### 1. عرض قائمة العقود
```
http://localhost:8080/contracts_list.php
```

### 2. تصدير عقد محدد
```
http://localhost:8080/export_pdf.php?id=1
```

### 3. اختبار النظام
```
http://localhost:8080/test_pdf.php
```

## الطباعة والتصدير

### طريقة 1: الطباعة المباشرة
1. افتح رابط تصدير العقد
2. اضغط Ctrl+P في المتصفح
3. اختر "حفظ كـ PDF"

### طريقة 2: استخدام أدوات المتصفح
1. افتح الأدوات Developer Tools (F12)
2. انتقل لتبويب Console
3. اكتب: `window.print()`

### طريقة 3: إضافات المتصفح
- يمكن استخدام إضافات مثل "PDF Printer"
- أو "Print Friendly & PDF"

## التخصيص

### تعديل التصميم
عدّل ملف `services/SimplePdfService.php` في قسم الـ CSS:

```css
/* الخطوط */
@import url("https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap");

/* الألوان */
.contract-document {
    color: #333;
    background: white;
}

/* التخطيط */
@media print {
    body { margin: 15mm; }
}
```

### إضافة حقول جديدة
1. عدّل دالة `prepareData()` في SimplePdfService
2. أضف المتغيرات في قالب HTML
3. استخدم التنسيق: `{{field_name}}`

## المتطلبات التقنية

### الخادم
- PHP 8.0 أو أحدث
- SQLite 3
- إضافات PHP: PDO, SQLite

### المتصفح
- Chrome, Firefox, Safari, Edge
- دعم CSS Grid و Flexbox
- دعم الطباعة والتصدير

## استكشاف الأخطاء

### مشكلة: العقد لا يظهر
**الحل:**
```php
// تحقق من وجود البيانات
var_dump($contract);
var_dump($detailedContract);
```

### مشكلة: التنسيق مكسور
**الحل:**
1. تحقق من صحة CSS
2. اختبر في متصفح مختلف
3. افحص Console للأخطاء

### مشكلة: الخطوط العربية
**الحل:**
```css
font-family: "Amiri", "Cairo", serif;
direction: rtl;
text-align: right;
```

## الخطوات التالية المقترحة

### 1. تحسينات إضافية
- [ ] إضافة ختم إلكتروني
- [ ] التوقيع الرقمي
- [ ] رمز QR للتحقق

### 2. ميزات متقدمة
- [ ] إرسال PDF بالإيميل
- [ ] حفظ تلقائي في السيرفر
- [ ] نسخ احتياطية

### 3. التكامل
- [ ] ربط مع أنظمة الأرشفة
- [ ] تصدير متعدد
- [ ] طباعة مجمعة

## الدعم والمساعدة

في حالة وجود مشاكل:
1. تحقق من logs الخادم
2. اختبر `test_pdf.php` أولاً
3. تأكد من تشغيل قاعدة البيانات
4. راجع ملف الأخطاء PHP

---

## تم الانتهاء بنجاح! ✅

✅ **ترقيم العقود التلقائي**: يعمل مع تنسيق B001-1447, B002-1447  
✅ **تصدير PDF**: نظام HTML/CSS مع إمكانية الطباعة  
✅ **واجهة المستخدم**: صفحة قائمة العقود مع أزرار التصدير  
✅ **الاختبار**: جميع المكونات تعمل بشكل صحيح  

**الخادم يعمل على:** http://localhost:8080  
**صفحة العقود:** http://localhost:8080/contracts_list.php  
**اختبار PDF:** http://localhost:8080/test_pdf.php